<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SpringBoot Thymeleaf</title>
    <script th:src="@{/js/jquery-3.4.1.js}"></script>
    <script th:src="@{/layui/layui.js}"></script>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">
    <style>
        td.layui-form-select{
            margin-top: -10px;
            margin-left: -15px;
            margin-right: -15px;
        }

        .layui-table-cell{
            overflow: visible;
        }
        .layui-table-box{
            overflow: visible;
        }
        .layui-select,.layui-input{
            height:30px;
        }
    </style>
</head>
<body>
<!--<table border="1px">-->
<!--    <tr>-->
<!--        <td>用户编号</td>-->
<!--        <td>用户名</td>-->
<!--        <td>用户密码</td>-->
<!--    </tr>-->
<!--    <tr th:each="user:${users}">-->
<!--        <td th:text="${user.id}"></td>-->
<!--        <td th:text="${user.userName}"></td>-->
<!--        <td th:text="${user.password}"></td>-->
<!--    </tr>-->

<!--</table>-->
<!--<div class="layui-btn-group" id="toolBarButton" style="display: none">-->
<!--    <button type="button" class="layui-btn" lay-event="add"><i class="layui-icon layui-icon-addition"></i>添加</button>-->
<!--    <button type="button" class="layui-btn layui-btn-danger" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</button>-->
<!--&lt;!&ndash;    <button type="button" class="layui-btn" onclick="window.location.href='logout'"><i class="layui-icon layui-icon-logout"></i>注销</button>&ndash;&gt;-->
<!--&lt;!&ndash;    <button type="button" class="layui-btn" onclick="window.location.href='toIndex'"><i class="layui-icon layui-icon-home"></i>首页</button>&ndash;&gt;-->
<!--</div>-->
<!--    <table class="layui-hide" id="demo"  lay-filter="test"></table>-->
<form class="layui-form" id="formPage" action="" style="display: none" method="post">
    <br><br>
    <div class="layui-form-item">
        <label class="layui-form-label">用户名</label>
        <div class="layui-input-inline">
            <input type="text" name="loginName" required lay-verify="required" placeholder="请输入用户名" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">用户昵称</label>
        <div class="layui-input-inline">
            <input type="text" name="userName" required lay-verify="required" placeholder="请输入用户昵称" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密  码</label>
        <div class="layui-input-inline">
            <input type="text" name="password" required lay-verify="required" placeholder="请输入密码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">角  色</label>
        <div class="layui-input-inline">
            <select name="roleName" lay-verify="required" id="roleSelect">
                <option value="">请选择角色</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">部  门</label>
        <div class="layui-input-inline">
            <select name="deptName" lay-verify="required" id="deptSelect">
                <option value="">请选择部门</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">状态</label>
        <div class="layui-input-block">
            <input type="checkbox" name="status" lay-skin="switch">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">性  别</label>
        <div class="layui-input-block">
            <input type="radio" name="sex" value="男" title="男" checked>
            <input type="radio" name="sex" value="女" title="女">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">电话号码</label>
        <div class="layui-input-inline">
            <input type="text" name="phoneNumber" placeholder="请输入电话号码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">邮箱</label>
        <div class="layui-input-inline">
            <input type="text" name="email" placeholder="请输入邮箱地址" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="insertButton">插入</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>

<!--后台布局-->
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo">后台用户管理系统</div>
        <!-- 头部区域（可配合layui已有的水平导航） -->
        <ul class="layui-nav layui-layout-left">
            <li class="layui-nav-item"><a th:href="@{/}">首页</a></li>
            <li class="layui-nav-item"><a href="">商品管理</a></li>
            <li class="layui-nav-item"><a href="">用户</a></li>
            <li class="layui-nav-item">
                <a href="javascript:;">其它系统</a>
                <dl class="layui-nav-child">
                    <dd><a href="">邮件管理</a></dd>
                    <dd><a href="">消息管理</a></dd>
                    <dd><a href="">授权管理</a></dd>
                </dl>
            </li>
        </ul>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
                    Rudy
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="">基本资料</a></dd>
                    <dd><a href="">安全设置</a></dd>
                </dl>
            </li>
            <li class="layui-nav-item"><a href="javascript:;" onclick="logout()"><i class="layui-icon layui-icon-logout"></i>退出</a></li>
        </ul>
    </div>

    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree"  lay-filter="test">
                <li class="layui-nav-item layui-nav-itemed">
                    <a class="" href="javascript:;">所有商品</a>
                    <dl class="layui-nav-child">
                        <dd><a href="javascript:;">列表一</a></dd>
                        <dd><a href="javascript:;">列表二</a></dd>
                        <dd><a href="javascript:;">列表三</a></dd>
                        <dd><a href="">超链接</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;">解决方案</a>
                    <dl class="layui-nav-child">
                        <dd><a href="javascript:;">列表一</a></dd>
                        <dd><a href="javascript:;">列表二</a></dd>
                        <dd><a href="">超链接</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item"><a href="">云市场</a></li>
                <li class="layui-nav-item"><a href="">发布商品</a></li>
            </ul>
        </div>
    </div>

    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div class="layui-btn-group" id="toolBarButton" style="display: none">
            <button type="button" class="layui-btn" lay-event="add"><i class="layui-icon layui-icon-addition"></i>添加</button>
            <button type="button" class="layui-btn layui-btn-danger" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</button>
            <!--    <button type="button" class="layui-btn" onclick="window.location.href='logout'"><i class="layui-icon layui-icon-logout"></i>注销</button>-->
            <!--    <button type="button" class="layui-btn" onclick="window.location.href='toIndex'"><i class="layui-icon layui-icon-home"></i>首页</button>-->
        </div>
        <table class="layui-hide" id="demo"  lay-filter="test"></table>
    </div>

    <div class="layui-footer">
        <!-- 底部固定区域 -->
        © rudy.com - 用户管理系统
    </div>
</div>
<!--<script th:src="@{/layui/layui.js}"></script>-->
<script>
    //JavaScript代码区域
    layui.use('element', function(){
        var element = layui.element;

    });
</script>
</body>


<!--表单-->
<script>
    layui.use(['form', 'layedit', 'laydate'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;
        //添加表单处角色下拉框数据加载
        $(function () {
            $.ajax({
                url : '/roleSelect',
                dataType : 'json',
                data : {'status' : 0},//查询状态为0的所有角色
                type : 'post',
                success : function (data) {
                    //遍历data
                    $.each(data, function (i, item) {//i表示要下标，item表示该下标的值
                        //添加一项
                        $('#roleSelect').append(new Option(item['roleName']),item['roleName']);//Option的第一个参数表示下拉框选项的真实值，第二参数表示展示内容
                    });
                    form.render('select');//最后重新渲染一下下拉框
                }
            })
        })
        //添加表单处部门下拉框数据加载
        $(function () {
            $.ajax({
                url : '/deptSelect',
                dataType : 'json',
                data : {'status' : 0},//查询状态为0的所有角色
                type : 'post',
                success : function (data) {
                    //遍历data
                    $.each(data, function (i, item) {//i表示要下标，item表示该下标的值
                        //添加一项
                        $('#deptSelect').append(new Option(item['deptName']),item['deptName']);//Option的第一个参数表示下拉框选项的真实值，第二参数表示展示内容
                    });
                    form.render('select');//最后重新渲染一下下拉框
                }
            })
        })
        //监听提交
        form.on('submit(insertButton)', function(data){
            var dataList = data.field;
            if (!dataList.hasOwnProperty("status")){
                dataList['status'] = "off";
            }
            // console.log(dataList);
            $.ajax({
                type : 'POST',
                url : "/insert",
                data : {"loginName" : dataList['loginName'],"userName" : dataList['userName'],"password" : dataList['password'],"roleName" : dataList['roleName'],"deptName" : dataList['deptName'],"status" : dataList['status'],"sex" : dataList['sex'],"phoneNumber" : dataList['phoneNumber'],"email" : dataList['email']},
                success : function (result) {
                    if (result.code == 0){
                        layer.closeAll();
                        reset();
                        layer.msg(result.message);
                    }
                    else {
                        layer.closeAll();
                        reset();
                        layer.msg(result.message);
                        myTable.reload();
                    }
                }
            });
            // $.post({
            //     url : "/insert",
            //     data : {"username" : dataList['username'],"password" : dataList['password']},
            //     success : function (result) {
            //         if (result.code == 0){
            //             layer.closeAll();
            //             layer.msg(result.message);
            //         }
            //         else {
            //             layer.closeAll();
            //             layer.msg(result.message);
            //             myTable.reload();
            //         }
            //     }
            // });
            // layer.alert(JSON.stringify(data.field), {
            //     title: '最终的提交信息'
            // })
            return false;
        });
    });
</script>
<script>
    var myTable;
    layui.use('table', function(){
        var table = layui.table;

        //第一个实例
        myTable = table.render({
            elem: '#demo'
            ,height: 400
            ,with: 800
            ,url: 'hello' //数据接口
            ,page: true //开启分页
            ,limit:5
            ,limits:[5,10,15,20,25,30]
            ,toolbar:'#toolBarButton'
            ,cols: [
                [ //表头
                    {field: 'checkBox', width:80, sort: true, fixed: 'left',checkbox: true}
                    ,{field: 'userId', title: '编号', width:80, sort: true, fixed: 'left'}
                    ,{field: 'loginName', title: '用户名', width:120}
                    ,{field: 'userName', title: '用户昵称', width:120}
                    ,{field: 'roleName'
                    ,title: '角色'
                    ,width:120
                    ,templet:function (d) {
                        var str = '<select name="roleTableSelect" lay-filter="roleTableSelect" lay-verify="required" id="roleTableSelect">';
                        $.ajax({
                            type : 'post',
                            url : '/roleSelect',
                            dataType : 'json',
                            async : false,
                            success : function (data) {
                                //console.log(data);
                                $.each(data,function (i, item) {
                                    str += '<option value='+item['roleName']+'>'+item['roleName']+'</option>';
                                });
                                str += '</select>'
                                // console.log("in:"+str);
                            }
                        });
                        //console.log(str);
                        return str;
                    }
                     }
                    ,{field: 'deptName', title: '部门', width:120}
                    ,{field: 'phoneNumber', title: '电话号码', width:120}
                    ,{field: 'email', title: '邮箱', width:200}
                    ,{field: 'sex', title: '性别', width:50}
                    ,{field: 'status',
                    title: '状态',
                    width:120,
                    templet:function (d) {
                        // if (d.status == '1'){
                        //     return '受限';
                        // }else
                        return '<select name = "statusSelect" lay-filter="statusSelect" lay-verify="required" data-state="'+d.status+'" data-value="'+d.id+'" id="statusSelect">'+
                                           '<option value="0">正常</option>'+
                                           '<option value="1">受限</option>'+
                                     '</select>'
                           }
                     }
                    // ,{field: 'salt', title: '盐值', width:200}
                    ,{field: 'option',title: '操作', width:220, fixed : 'right' , toolbar: '#barDemo'}
                ]
            ]
            ,done:function (res,curr,count) {
                console.log(res.data[1].roleName);
                $("#roleTableSelect option[value='普通人员']").attr("selected",true);
                table.render('select');
            }
        });

        //监听头工具栏
        table.on('toolbar(test)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id)
                ,data = checkStatus.data; //获取选中的数据
            console.log(data);
            //var data = obj.data;
            if (obj.event === 'del'){
                if (data.length === 0){
                    $('#statusSelect').append(new Option("2","变态"));
                    myTable.reload();
                    layer.msg("请勾选要删除的行！");
                }
                else {
                    layer.confirm("确定要删除吗？",{
                        btn : ['确定', '取消'],
                        btn2 : function (index) {
                        }
                    },function (index) {
                        var list = [];
                        for (var i = 0;i < data.length;i++){
                            list.push(data[i].userId);
                        }
                        $.post({
                            url : "/toolbarDelete",
                            data : {list : JSON.stringify(list)},
                            success : function (result) {
                                layer.msg(result);
                                myTable.reload();
                            }
                        })
                    })
                }
            }
            else if (obj.event === 'add'){
                insert();
            }
        })

        //监听行工具栏tool按钮的事件
        table.on('tool(test)', function(obj){
            var data = obj.data;
            //详情按钮监听
            if(obj.event === 'detail'){
                //layer.msg('ID：'+ data.id + ' 的查看操作');
                layer.open({
                    type: 1
                    ,title: false //不显示标题栏
                    ,closeBtn: false
                    ,area: '300px;'
                    ,shade: 0.8
                    ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                    ,btn: ['确定']
                    ,btnAlign: 'c'
                    ,moveType: 1 //拖拽模式，0或者1
                    ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">用户信息：</div>'
                })
            } else if(obj.event === 'del'){//删除按钮监听
                layer.confirm('真的删除行么', function (index) {
                    $.post({
                        url : "/toolDelete",
                        data : {"userId" : data['userId']},
                        success : function (data) {
                            layer.msg(data);
                            myTable.reload();
                        }
                    })
                })
            } else if(obj.event === 'edit'){
                edit(obj);
                //layer.alert('编辑行：<br>'+ JSON.stringify(data)+"==============================="+JSON.stringify(obj.tr.find("td"))+"==============================="+JSON.stringify(obj.tr.find("tr")))
            }
            else if (obj.event === 'update'){//更改按钮监听
                var origin = obj;
                update(origin,obj);
            }

            //编辑按钮函数
            function edit(obj) {
                //设置该行为可编辑
                obj.tr.find("td").attr("data-edit","text");
                //移除指定单元格的点击无效效果
                obj.tr.find('td[data-field="userName"]').removeAttr("style","pointer-events:none;");
                obj.tr.find('td[data-field="password"]').removeAttr("style","pointer-events:none;");
                obj.tr.find('td[data-field="salt"]').removeAttr("style","pointer-events:none;");
                obj.tr.find('td[data-field="userId"]').removeAttr('data-edit');
                //移除指定表格的可编辑属性
                obj.tr.find('td[data-field="userId"]').removeAttr('data-edit');
                obj.tr.find('td[data-field="password"]').removeAttr('data-edit');
                obj.tr.find('td[data-field="option"]').removeAttr('data-edit');
                //设置该行背景色
                obj.tr.attr("style","background-color:yellow");
                layer.msg('点击对应单元格进行修改')
                obj.tr.find("a:eq(1)").text("更新").addClass("layui-btn-warm").removeAttr("lay-event").attr("lay-event","update");
            }

            //更改按钮函数
            function update(origin,obj) {
                var data = obj.data;
                //console.log(data);
                $.post({
                    url : "/update",
                    data : {"userId":data['userId'],"userName":data['userName'],"password":data['password'],"salt":data['salt']},
                    success : function (data) {
                        layer.msg(data);
                        //console.log(data);
                        myTable.reload();
                    }
                })
                obj.tr.find("a:eq(1)").text("编辑").removeClass("layui-btn-warm").removeAttr("lay-event").attr("lay-event","edit");
                // 移除当前行可编辑标签
                obj.tr.find("td").removeAttr("data-edit");
                // 设定当前行所有点击效果无效
                obj.tr.find('td[data-field="username"]').attr("style","pointer-events:none;");
                obj.tr.find('td[data-field="password"]').attr("style","pointer-events:none;");
                obj.tr.find('td[data-field="salt"]').attr("style","pointer-events:none;");
                //去除行内工具点击效果无效
                //obj.tr.find("td:eq(0)").removeAttr("style", "pointer-events:none;");
                obj.tr.removeAttr('style');
            }
        });
    });
</script>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="reset"><i class="layui-icon layui-icon-key"></i>重置</a>
    <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-close"></i>删除</a>

    <!-- 这里同样支持 laytpl 语法，如： -->
    {{#  if(d.auth > 2){ }}
    <a class="layui-btn layui-btn-xs" lay-event="check">审核</a>
    {{#  } }}
</script>
//设置角色下拉框单元格的样式




<script>
    //表头添加按钮函数
    function insert() {
        //页面层
        layer.open({
            type: 1,
            title:"添加用户",
            skin: 'layui-layer-rim', //加上边框
            area: ['420px', '520px'], //宽高
            content: $('#formPage') //调到新增页面
        });
    }
</script>
<script>
    function logout() {
        layer.confirm("确定退出吗？",{
            btn : ['确定','取消'],
            btn2 : function () {
            },
        },function () {
            //console.log("退出");
            location.href = "/logout";
            // $.ajax({
            //     url : "/logout"
            // })
        })
    }
</script>
<script>
    function submit(callback){
        document.getElementById("formPage").submit();
        callback();
    }
    function reset(){
        document.getElementById("formPage").reset();
    }
    function insertClick(){
        submit();
    }
</script>
</html>